<!DOCTYPE html><html lang="zh-CN"><head><!-- hexo injector head_begin start --><link href="/css/hexo-tag-common.css" rel="stylesheet"/><!-- hexo injector head_begin end --><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="è¯­å†°"><meta name="copyright" content="è¯­å†°"><meta name="generator" content="Hexo 6.0.0"><meta name="theme" content="hexo-theme-yun"><title>ucosiiå­¦ä¹ 1-éª—è¿‡ç¼–è¯‘å™¨ | è¯­å†°çš„å°ç«™</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.2.4/dist/yun/yun-markdown.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prism-theme-vars/base.css"><script src="//at.alicdn.com/t/font_1140697_dxory92pb0h.js" async></script><script src="https://cdn.jsdelivr.net/npm/@unocss/runtime/mini.global.js"></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>function initScrollReveal() {
  [".post-card",".markdown-body img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
}
document.addEventListener("DOMContentLoaded", initScrollReveal);
document.addEventListener("pjax:success", initScrollReveal);
</script><link rel="icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#0078E7"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    window.Yun = {}
    window.CONFIG = {"hostname":"feutis.github.io","root":"/","title":"äº‘æ¸¸å›çš„å°ç«™","version":"1.8.10","mode":"auto","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"æœç´¢...","empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹: ${query}","hits":"æ‰¾åˆ° ${hits} æ¡ç»“æœ","hits_time":"æ‰¾åˆ° ${hits} æ¡ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"fireworks":{"colors":null},"vendors":{"darken":"https://cdn.jsdelivr.net/npm/darken@1.5.0"}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/hexo-theme-yun.js" type="module"></script><link rel="alternate" href="/atom.xml" title="è¯­å†°çš„å°ç«™" type="application/atom+xml"><script>(function(){
  var bp = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
    bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else {
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})();</script><meta name="description" content="æˆ‘ä»¬å¯ä»¥ä»ucosiiå®˜ç½‘ä¸‹è½½åˆ°ucosiiçš„æºä»£ç ï¼Œé€šè¿‡ä¸€æ¬¡æ¬¡çš„ç¼–è¯‘ï¼Œè§‚å¯Ÿé”™è¯¯ä¿¡æ¯ï¼Œç»“åˆucosiiå·¥ç¨‹æ–‡ä»¶çš„æ¶æ„ï¼Œæˆ‘ä»¬å¯ä»¥å»ºç«‹èµ·ä¸€ä¸ªåˆæ­¥çš„åªèƒ½éª—è¿‡ç¼–è¯‘å™¨çš„ucosiiç‰ˆæœ¬ã€‚">
<meta property="og:type" content="article">
<meta property="og:title" content="ucosiiå­¦ä¹ 1-éª—è¿‡ç¼–è¯‘å™¨">
<meta property="og:url" content="http://feutis.github.io/ucosii/ucosii1/index.html">
<meta property="og:site_name" content="è¯­å†°çš„å°ç«™">
<meta property="og:description" content="æˆ‘ä»¬å¯ä»¥ä»ucosiiå®˜ç½‘ä¸‹è½½åˆ°ucosiiçš„æºä»£ç ï¼Œé€šè¿‡ä¸€æ¬¡æ¬¡çš„ç¼–è¯‘ï¼Œè§‚å¯Ÿé”™è¯¯ä¿¡æ¯ï¼Œç»“åˆucosiiå·¥ç¨‹æ–‡ä»¶çš„æ¶æ„ï¼Œæˆ‘ä»¬å¯ä»¥å»ºç«‹èµ·ä¸€ä¸ªåˆæ­¥çš„åªèƒ½éª—è¿‡ç¼–è¯‘å™¨çš„ucosiiç‰ˆæœ¬ã€‚">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/fffyutt/img/raw/blog/img/202202261611897.png">
<meta property="og:image" content="https://gitee.com/fffyutt/img/raw/blog/img/202202261611217.png">
<meta property="og:image" content="https://gitee.com/fffyutt/img/raw/blog/img/202202261611424.png">
<meta property="og:image" content="d:%5CDesktop%5Cimage_warehouse%5Cimg%5Cimage-20210309210144330.png">
<meta property="og:image" content="https://gitee.com/fffyutt/img/raw/blog/img/202202261611976.png">
<meta property="og:image" content="https://gitee.com/fffyutt/img/raw/blog/img/202202261612222.png">
<meta property="og:image" content="https://gitee.com/fffyutt/img/raw/blog/img/202202261612068.png">
<meta property="og:image" content="https://fffyutt.gitee.io/image_warehouse/ucosii1/image-20210309215209125.png">
<meta property="og:image" content="https://gitee.com/fffyutt/img/raw/blog/img/202202261612471.png">
<meta property="og:image" content="https://gitee.com/fffyutt/img/raw/blog/img/202202261612381.png">
<meta property="og:image" content="https://gitee.com/fffyutt/img/raw/blog/img/202202261612226.png">
<meta property="og:image" content="https://gitee.com/fffyutt/img/raw/blog/img/202202261612498.png">
<meta property="og:image" content="https://gitee.com/fffyutt/img/raw/blog/img/202202261612045.png">
<meta property="og:image" content="https://gitee.com/fffyutt/img/raw/blog/img/202202261612697.png">
<meta property="og:image" content="https://gitee.com/fffyutt/img/raw/blog/img/202202261612158.png">
<meta property="article:published_time" content="2021-04-01T14:04:38.000Z">
<meta property="article:modified_time" content="2022-02-26T08:12:38.732Z">
<meta property="article:author" content="è¯­å†°">
<meta property="article:tag" content="ucosii">
<meta property="article:tag" content="stm32">
<meta property="article:tag" content="å­¦ä¹ ç¬”è®°">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/fffyutt/img/raw/blog/img/202202261611897.png"><script>(function() {
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
  const setting = localStorage.getItem('darken-mode') || 'auto'
  if (setting === 'dark' || (prefersDark && setting !== 'light'))
    document.documentElement.classList.toggle('dark', true)
})()</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js" type="module"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js" type="module"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="æ–‡ç« ç›®å½•"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="ç«™ç‚¹æ¦‚è§ˆ"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="è¯­å†°"><img width="96" loading="lazy" src="/images/avatar.jpg" alt="è¯­å†°"><span class="site-author-status" title="Looking for dawn.">ğŸŒ‘</span></a><div class="site-author-name"><a href="/about/">è¯­å†°</a></div><span class="site-name">è¯­å†°çš„å°ç«™</span><sub class="site-subtitle">like a stone</sub><div class="site-desciption">ç§¯è·¬æ­¥ä»¥è‡³åƒé‡Œ</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="é¦–é¡µ"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="å½’æ¡£"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">8</span></a></div><div class="site-state-item"><a href="/categories/" title="åˆ†ç±»"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">6</span></a></div><div class="site-state-item"><a href="/tags/" title="æ ‡ç­¾"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">11</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="æ–‡æ¡£"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://jq.qq.com/?_wv=1027&amp;k=g4CvG7jI" title="QQç¾¤" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/feutis" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="1276018778@qq.com" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="æˆ‘çš„å°ä¼™ä¼´ä»¬" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a><a class="links-item hty-icon-button" href="/girls/" title="å–œæ¬¢çš„å¥³å­©å­" style="color:hotpink"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-women-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%B9%95"><span class="toc-number">1.</span> <span class="toc-text"> å¼€å¹•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E5%AE%B9%E7%AE%80%E4%BB%8B"><span class="toc-number">2.</span> <span class="toc-text"> å†…å®¹ç®€ä»‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A3%E6%96%87"><span class="toc-number">3.</span> <span class="toc-text"> æ­£æ–‡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E7%A8%8B%E9%AA%8C%E8%AF%81"><span class="toc-number">3.1.</span> <span class="toc-text"> å·¥ç¨‹éªŒè¯</span></a></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article" style="--smc-primary:#0078E7;"><link itemprop="mainEntityOfPage" href="http://feutis.github.io/ucosii/ucosii1/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="è¯­å†°"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="è¯­å†°çš„å°ç«™"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">ucosiiå­¦ä¹ 1-éª—è¿‡ç¼–è¯‘å™¨<a class="post-edit-link" href="https://github.com/feutis/feutis.github.io_posts/ucosii/ucosii1.md" target="_blank" title="ç¼–è¾‘" rel="noopener"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-edit-line"></use></svg></a></h1><div class="post-meta"><div class="post-time"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="åˆ›å»ºæ—¶é—´ï¼š2021-04-01 22:04:38" itemprop="dateCreated datePublished" datetime="2021-04-01T22:04:38+08:00">2021-04-01</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="ä¿®æ”¹æ—¶é—´ï¼š2022-02-26 16:12:38" itemprop="dateModified" datetime="2022-02-26T16:12:38+08:00">2022-02-26</time></div><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category-item" href="/categories/ucosii/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">ucosii</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag-item" href="/tags/ucosii/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">ucosii</span></a><a class="tag-item" href="/tags/stm32/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">stm32</span></a><a class="tag-item" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">å­¦ä¹ ç¬”è®°</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body"><h2 id="å¼€å¹•"><a class="markdownIt-Anchor" href="#å¼€å¹•"></a> å¼€å¹•</h2>
<p>æœ¬æ–‡ç”¨ä½œè®°å½•è‡ªå·±å­¦ä¹ ucosiiå¹¶åœ¨å››è½´é£è¡Œå™¨ç»¼åˆè¯¾ç¨‹è®¾è®¡çš„å­¦ä¹ ä¸å®è·µè¿‡ç¨‹ï¼Œä¸»è¦ç»“åˆcotex-m4å†…æ ¸çš„STM32F401REæ¿å­è¿›è¡Œucosiiçš„å­¦ä¹ ä¸ç§»æ¤ã€‚å­¦ä¹ çš„è¿‡ç¨‹å¾ˆç—›è‹¦ï¼Œå¸Œæœ›è‡ªå·±èƒ½å¤ŸåšæŒè®°å½•åˆ°æœ€åï¼</p>
<h2 id="å†…å®¹ç®€ä»‹"><a class="markdownIt-Anchor" href="#å†…å®¹ç®€ä»‹"></a> å†…å®¹ç®€ä»‹</h2>
<p>æˆ‘ä»¬å¯ä»¥ä»ucosiiå®˜ç½‘ä¸‹è½½åˆ°ucosiiçš„æºä»£ç ï¼Œé€šè¿‡ä¸€æ¬¡æ¬¡çš„ç¼–è¯‘ï¼Œè§‚å¯Ÿé”™è¯¯ä¿¡æ¯ï¼Œç»“åˆucosiiå·¥ç¨‹æ–‡ä»¶çš„æ¶æ„ï¼Œæˆ‘ä»¬å¯ä»¥å»ºç«‹èµ·ä¸€ä¸ªåˆæ­¥çš„åªèƒ½éª—è¿‡ç¼–è¯‘å™¨çš„ucosiiç‰ˆæœ¬ã€‚</p>
<h2 id="æ­£æ–‡"><a class="markdownIt-Anchor" href="#æ­£æ–‡"></a> æ­£æ–‡</h2>
<p>ä¸ºäº†æ„å»ºèµ·ucosiiçš„å·¥ç¨‹æ–‡ä»¶ï¼Œæˆ‘ä»¬é¦–å…ˆè¦æ–°å»ºä¸€ä¸ªå·¥ç¨‹ï¼ŒæŒ‰ç…§ucosiiå·¥ç¨‹æ–‡ä»¶çš„æ ·å­æ·»åŠ ç›®å½•ï¼Œç¼–è¯‘è·¯å¾„ä»¥åŠå¯åŠ¨æ–‡ä»¶ã€‚</p>
<p><img src="https://gitee.com/fffyutt/img/raw/blog/img/202202261611897.png" alt="image-20210309203531760" / loading="lazy"></p>
<p>åœ¨ç¼–è¯‘COREå†…çš„æ–‡ä»¶æ—¶ï¼Œå‘ç°ç¼ºå°‘æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥æ‰“å¼€ç¬¬ä¸€ä¸ªæŠ¥é”™çš„æ–‡ä»¶</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;app_cfg.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;os_cfg.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;os_cpu.h></span></span></code></pre>
<p>åœ¨44è¡Œçš„includeé‡Œå°±é”™äº†ï¼Œæˆ‘ä»¬å‘ç°è¿™åé¢è¿˜æœ‰ä¸¤ä¸ªincludeï¼Œé‡Œé¢çš„æ–‡ä»¶éƒ½æ˜¯å·¥ç¨‹ä¸­æ²¡æœ‰çš„ï¼Œæˆ‘ä»¬ç›´æ¥æŒ‰ç…§ä¹‹å‰ç»“æ„åŠ å…¥æ–‡ä»¶(éƒ½æ˜¯ç©ºçš„)</p>
<p>è¿™æ—¶æˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ä¸ªè¿™æ ·çš„æ–‡ä»¶å¤¹ï¼Œå…¶ä¸­é™¤COREå†…çš„æ–‡ä»¶å¤–ï¼Œå…¶ä»–æ–‡ä»¶å¤¹å†…çš„æ–‡ä»¶éƒ½æ˜¯ç©ºçš„ã€‚</p>
<p>æ ¹æ®è‰¯å¥½çš„ä¹ æƒ¯ï¼Œæˆ‘ä»¬åœ¨å¤´æ–‡ä»¶ä¸­éƒ½åŠ å…¥ä¸‹é¢è¿™è¡Œä»£ç æ”¾ç½®é‡å¤ç¼–è¯‘</p>
<pre class="language-none"><code class="language-none">#pragma once</code></pre>
<p>ä½ æƒ³ç”¨ä¸‹é¢è¿™ç§æ–¹æ³•æˆ‘ä¹Ÿä¸æ‹¦ç€ä½ ï¼Œè¿™ä¸ªå’Œå®˜æ–¹ä½¿ç”¨çš„æ–¹æ³•æ˜¯ä¸€æ ·çš„ï¼ŒäºŒè€…çš„åŒºåˆ«è‡ªè¡ŒæŸ¥æ‰¾</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">OS_CFG_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_CFG_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></code></pre>
<p>å†æ¬¡ç¼–è¯‘ï¼Œç¼–è¯‘ä¹‹å‰æ³¨æ„æ‰€æœ‰çš„æ–‡ä»¶åé¢åŠ ä¸ªç©ºè¡Œï¼Œè¿™ä¸ªæ˜¯è€ç‰ˆæœ¬gccçš„é—®é¢˜äº†ï¼Œå¯è§keilè‡ªå¸¦çš„ç¼–è¯‘å™¨ç‰ˆæœ¬æ¯”è¾ƒè€ï¼Œåªèƒ½å°†å°±ç€ç”¨äº†</p>
<p><img src="https://gitee.com/fffyutt/img/raw/blog/img/202202261611217.png" alt="image-20210309205046991" / loading="lazy"></p>
<p>emmmmä¸€å †undefinedï¼Œå¥½å§è®©æˆ‘ä»¬å»æ‰¾åˆ°ä»–ä»¬ã€‚</p>
<p>åœ¨os_cpu.håŠ å…¥å¦‚ä¸‹ä»£ç </p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span>  BOOLEAN<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span>  INT8U<span class="token punctuation">;</span>			<span class="token comment">/* Unsigned  8 bit quantity       */</span>
<span class="token keyword">typedef</span> <span class="token keyword">signed</span>   <span class="token keyword">char</span>  INT8S<span class="token punctuation">;</span>			<span class="token comment">/* Signed    8 bit quantity       */</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> INT16U<span class="token punctuation">;</span>			<span class="token comment">/* Unsigned 16 bit quantity       */</span>
<span class="token keyword">typedef</span> <span class="token keyword">signed</span>   <span class="token keyword">short</span> INT16S<span class="token punctuation">;</span>			<span class="token comment">/* Signed   16 bit quantity       */</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span>   INT32U<span class="token punctuation">;</span>			<span class="token comment">/* Unsigned 32 bit quantity       */</span>
<span class="token keyword">typedef</span> <span class="token keyword">signed</span>   <span class="token keyword">int</span>   INT32S<span class="token punctuation">;</span>			<span class="token comment">/* Signed   32 bit quantity       */</span>
<span class="token keyword">typedef</span> <span class="token keyword">float</span>          FP32<span class="token punctuation">;</span>			<span class="token comment">/* Single precision floating point*/</span>
<span class="token keyword">typedef</span> <span class="token keyword">double</span>         FP64<span class="token punctuation">;</span>			<span class="token comment">/* Double precision floating point*/</span>

<span class="token comment">//STM32æ˜¯32ä½ä½å®½çš„,è¿™é‡ŒOS_STKå’ŒOS_CPU_SRéƒ½åº”è¯¥ä¸º32ä½æ•°æ®ç±»å‹</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span>   OS_STK<span class="token punctuation">;</span>			<span class="token comment">/* Each stack entry is 32-bit wide*/</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span>   OS_CPU_SR<span class="token punctuation">;</span>		<span class="token comment">/* Define size of CPU status register*/</span>
</code></pre>
<p>å†æ¬¡ç¼–è¯‘</p>
<p><img src="https://gitee.com/fffyutt/img/raw/blog/img/202202261611424.png" alt="image-20210309210015435" / loading="lazy"></p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token number">672</span>   OS_EXT  OS_PRIO           OSRdyTbl<span class="token punctuation">[</span>OS_RDY_TBL_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>       <span class="token comment">/* Table of tasks which are ready to run    */</span></code></pre>
<p>å¥½åƒå’ŒOS_LOWEST_PRIOæ²¡ä»€ä¹ˆå…³ç³»ï¼Œç”¨vscodeè¯•è¯•</p>
<p><img src="D:%5CDesktop%5Cimage_warehouse%5Cimg%5Cimage-20210309210144330.png" alt="image-20210309210144330" / loading="lazy"></p>
<p>oké‚£å°±è¿˜æ˜¯æ²¡æœ‰å®šä¹‰çš„é—®é¢˜ï¼Œæˆ‘ä»¬å†å»æ‰¾æ‰¾è¿™æ®µä»£ç ï¼Œåœ¨os_dfg.hé‡Œé¢æ‰¾åˆ°äº†ï¼Œçœ‹ä¸æ‡‚ï¼Œç›´æ¥ç…§æŠ„</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">OS_CFG_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_CFG_H</span></span>


                                       <span class="token comment">/* ---------------------- MISCELLANEOUS ----------------------- */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_APP_HOOKS_EN</span>           <span class="token expression"><span class="token number">0u</span>   </span><span class="token comment">/* Application-defined hooks are called from the uC/OS-II hooks */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_ARG_CHK_EN</span>             <span class="token expression"><span class="token number">0u</span>   </span><span class="token comment">/* Enable (1) or Disable (0) argument checking                  */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_CPU_HOOKS_EN</span>           <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/* uC/OS-II hooks are found in the processor port files         */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_DEBUG_EN</span>               <span class="token expression"><span class="token number">0u</span>   </span><span class="token comment">/* Enable(1) debug variables                                    */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_EVENT_MULTI_EN</span>         <span class="token expression"><span class="token number">0u</span>   </span><span class="token comment">/* Include code for OSEventPendMulti()                          */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_EVENT_NAME_EN</span>          <span class="token expression"><span class="token number">0u</span>   </span><span class="token comment">/* Enable names for Sem, Mutex, Mbox and Q                      */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_LOWEST_PRIO</span>           <span class="token expression"><span class="token number">63u</span>   </span><span class="token comment">/* Defines the lowest priority that can be assigned ...         */</span></span>
                                       <span class="token comment">/* ... MUST NEVER be higher than 254!                           */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_MAX_EVENTS</span>            <span class="token expression"><span class="token number">10u</span>   </span><span class="token comment">/* Max. number of event control blocks in your application      */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_MAX_FLAGS</span>              <span class="token expression"><span class="token number">5u</span>   </span><span class="token comment">/* Max. number of Event Flag Groups    in your application      */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_MAX_MEM_PART</span>           <span class="token expression"><span class="token number">0u</span>   </span><span class="token comment">/* Max. number of memory partitions                             */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_MAX_QS</span>                 <span class="token expression"><span class="token number">5u</span>   </span><span class="token comment">/* Max. number of queue control blocks in your application      */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_MAX_TASKS</span>             <span class="token expression"><span class="token number">10u</span>   </span><span class="token comment">/* Max. number of tasks in your application, MUST be >= 2       */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_SCHED_LOCK_EN</span>          <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/* Include code for OSSchedLock() and OSSchedUnlock()           */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_TICK_STEP_EN</span>           <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/* Enable tick stepping feature for uC/OS-View                  */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_TICKS_PER_SEC</span>       	<span class="token expression"><span class="token number">200u</span>   </span><span class="token comment">/* Set the number of ticks in one second                        */</span></span>


                                       <span class="token comment">/* --------------------- TASK STACK SIZE ---------------------- */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_TASK_TMR_STK_SIZE</span>    <span class="token expression"><span class="token number">128u</span>   </span><span class="token comment">/* Timer      task stack size (# of OS_STK wide entries)        */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_TASK_STAT_STK_SIZE</span>   <span class="token expression"><span class="token number">128u</span>   </span><span class="token comment">/* Statistics task stack size (# of OS_STK wide entries)        */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_TASK_IDLE_STK_SIZE</span>   <span class="token expression"><span class="token number">128u</span>   </span><span class="token comment">/* Idle       task stack size (# of OS_STK wide entries)        */</span></span>


                                       <span class="token comment">/* --------------------- TASK MANAGEMENT ---------------------- */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_TASK_CHANGE_PRIO_EN</span>    <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSTaskChangePrio()                      */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_TASK_CREATE_EN</span>         <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSTaskCreate()                          */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_TASK_CREATE_EXT_EN</span>     <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSTaskCreateExt()                       */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_TASK_DEL_EN</span>            <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSTaskDel()                             */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_TASK_NAME_EN</span>           <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Enable task names                                        */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_TASK_PROFILE_EN</span>        <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include variables in OS_TCB for profiling                */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_TASK_QUERY_EN</span>          <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSTaskQuery()                           */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_TASK_REG_TBL_SIZE</span>      <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Size of task variables array (#of INT32U entries)        */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_TASK_STAT_EN</span>           <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Enable (1) or Disable(0) the statistics task             */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_TASK_STAT_STK_CHK_EN</span>   <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Check task stacks from statistic task                    */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_TASK_SUSPEND_EN</span>        <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSTaskSuspend() and OSTaskResume()      */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_TASK_SW_HOOK_EN</span>        <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSTaskSwHook()                          */</span></span>


                                       <span class="token comment">/* ----------------------- EVENT FLAGS ------------------------ */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_FLAG_EN</span>                <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/* Enable (1) or Disable (0) code generation for EVENT FLAGS    */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_FLAG_ACCEPT_EN</span>         <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSFlagAccept()                          */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_FLAG_DEL_EN</span>            <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSFlagDel()                             */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_FLAG_NAME_EN</span>           <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Enable names for event flag group                        */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_FLAG_QUERY_EN</span>          <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSFlagQuery()                           */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_FLAG_WAIT_CLR_EN</span>       <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/* Include code for Wait on Clear EVENT FLAGS                   */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_FLAGS_NBITS</span>           <span class="token expression"><span class="token number">16u</span>   </span><span class="token comment">/* Size in #bits of OS_FLAGS data type (8, 16 or 32)            */</span></span>


                                       <span class="token comment">/* -------------------- MESSAGE MAILBOXES --------------------- */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_MBOX_EN</span>                <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/* Enable (1) or Disable (0) code generation for MAILBOXES      */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_MBOX_ACCEPT_EN</span>         <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSMboxAccept()                          */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_MBOX_DEL_EN</span>            <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSMboxDel()                             */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_MBOX_PEND_ABORT_EN</span>     <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSMboxPendAbort()                       */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_MBOX_POST_EN</span>           <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSMboxPost()                            */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_MBOX_POST_OPT_EN</span>       <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSMboxPostOpt()                         */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_MBOX_QUERY_EN</span>          <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSMboxQuery()                           */</span></span>


                                       <span class="token comment">/* --------------------- MEMORY MANAGEMENT -------------------- */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_MEM_EN</span>                 <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/* Enable (1) or Disable (0) code generation for MEMORY MANAGER */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_MEM_NAME_EN</span>            <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Enable memory partition names                            */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_MEM_QUERY_EN</span>           <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSMemQuery()                            */</span></span>


                                       <span class="token comment">/* ---------------- MUTUAL EXCLUSION SEMAPHORES --------------- */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_MUTEX_EN</span>               <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/* Enable (1) or Disable (0) code generation for MUTEX          */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_MUTEX_ACCEPT_EN</span>        <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSMutexAccept()                         */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_MUTEX_DEL_EN</span>           <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSMutexDel()                            */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_MUTEX_QUERY_EN</span>         <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSMutexQuery()                          */</span></span>


                                       <span class="token comment">/* ---------------------- MESSAGE QUEUES ---------------------- */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_Q_EN</span>                   <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/* Enable (1) or Disable (0) code generation for QUEUES         */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_Q_ACCEPT_EN</span>            <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSQAccept()                             */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_Q_DEL_EN</span>               <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSQDel()                                */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_Q_FLUSH_EN</span>             <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSQFlush()                              */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_Q_PEND_ABORT_EN</span>        <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSQPendAbort()                          */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_Q_POST_EN</span>              <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSQPost()                               */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_Q_POST_FRONT_EN</span>        <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSQPostFront()                          */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_Q_POST_OPT_EN</span>          <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSQPostOpt()                            */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_Q_QUERY_EN</span>             <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSQQuery()                              */</span></span>


                                       <span class="token comment">/* ------------------------ SEMAPHORES ------------------------ */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_SEM_EN</span>                 <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/* Enable (1) or Disable (0) code generation for SEMAPHORES     */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_SEM_ACCEPT_EN</span>          <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*    Include code for OSSemAccept()                            */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_SEM_DEL_EN</span>             <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*    Include code for OSSemDel()                               */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_SEM_PEND_ABORT_EN</span>      <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*    Include code for OSSemPendAbort()                         */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_SEM_QUERY_EN</span>           <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*    Include code for OSSemQuery()                             */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_SEM_SET_EN</span>             <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*    Include code for OSSemSet()                               */</span></span>


                                       <span class="token comment">/* --------------------- TIME MANAGEMENT ---------------------- */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_TIME_DLY_HMSM_EN</span>       <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSTimeDlyHMSM()                         */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_TIME_DLY_RESUME_EN</span>     <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSTimeDlyResume()                       */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_TIME_GET_SET_EN</span>        <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSTimeGet() and OSTimeSet()             */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_TIME_TICK_HOOK_EN</span>      <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Include code for OSTimeTickHook()                        */</span></span>


                                       <span class="token comment">/* --------------------- TIMER MANAGEMENT --------------------- */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_TMR_EN</span>                 <span class="token expression"><span class="token number">0u</span>   </span><span class="token comment">/* Enable (1) or Disable (0) code generation for TIMERS         */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_TMR_CFG_MAX</span>           <span class="token expression"><span class="token number">16u</span>   </span><span class="token comment">/*     Maximum number of timers                                 */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_TMR_CFG_NAME_EN</span>        <span class="token expression"><span class="token number">1u</span>   </span><span class="token comment">/*     Determine timer names                                    */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_TMR_CFG_WHEEL_SIZE</span>     <span class="token expression"><span class="token number">8u</span>   </span><span class="token comment">/*     Size of timer wheel (#Spokes)                            */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OS_TMR_CFG_TICKS_PER_SEC</span> <span class="token expression"><span class="token number">10u</span>   </span><span class="token comment">/*     Rate at which timer management task runs (Hz)            */</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre>
<p>å†æ¬¡ç¼–è¯‘ï¼Œæ³¨æ„åˆ°è¿™æ¬¡å‡ºç°äº†ä¸€ç§compilingè­¦å‘Šå’Œä¸€ç§linkingé”™è¯¯ï¼Œä¼¼ä¹ï¼Œå‰è¿›äº†ä¸€å¤§æ­¥ï¼Ÿ</p>
<p><img src="https://gitee.com/fffyutt/img/raw/blog/img/202202261611976.png" alt="image-20210309210959168" / loading="lazy"></p>
<p><img src="https://gitee.com/fffyutt/img/raw/blog/img/202202261612222.png" alt="image-20210309211022041" / loading="lazy"></p>
<p>è§‚å¯Ÿä¸‹è­¦å‘Šç±»å‹ï¼Œåªæœ‰ä¸¤æ¡</p>
<pre class="language-none"><code class="language-none">warning:  #223-D: function &quot;OS_EXIT_CRITICAL&quot; declared implicitly
warning:  #223-D: function &quot;OS_ENTER_CRITICAL&quot; declared implicitly</code></pre>
<p>å…ˆå¤„ç†è­¦å‘Šï¼Œç”¨vscodeæ‰¾åˆ°è¿™ä¿©å‡½æ•°åœ¨ä»€ä¹ˆä½ç½®</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name function">OS_ENTER_CRITICAL</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>cpu_sr <span class="token operator">=</span> <span class="token function">OS_CPU_SR_Save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name function">OS_EXIT_CRITICAL</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token punctuation">&#123;</span><span class="token function">OS_CPU_SR_Restore</span><span class="token punctuation">(</span>cpu_sr<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span></span></span></code></pre>
<p>æŒºå¥½ï¼Œç­‰å¾…ï¼Œè¿™åé¢çš„OS_CPU_SR_Save()ä»€ä¹ˆçš„åˆæ˜¯å•¥ï¼Ÿ</p>
<p>æˆ‘ä»¬åˆåœ¨os_cpu.hé‡Œæ‰¾åˆ°äº†è¿™ä¸ªä¸œè¥¿ï¼Œå¥½ï¼Œä¸€èµ·åŠ è¿›å»</p>
<pre class="language-none"><code class="language-none">OS_CPU_SR  OS_CPU_SR_Save(void);
void       OS_CPU_SR_Restore(OS_CPU_SR cpu_sr);</code></pre>
<p>çœŸä¸é”™ï¼ŒåŠ è¿›å»ä»¥ååˆå¼€å§‹æŠ¥ç¼–è¯‘erroräº†ã€‚ã€‚å›åˆ°åŸç‚¹</p>
<p><img src="https://gitee.com/fffyutt/img/raw/blog/img/202202261612068.png" alt="image-20210309212602348" / loading="lazy"></p>
<p>çœ‹çœ‹ï¼Œç»å¤§å¤šæ•°é”™è¯¯æ˜¯cpu_sræœªå®šä¹‰ï¼Œç¡®å®ï¼Œåˆšåˆšåªæ³¨æ„åˆ°ç¬¬ä¸€å±‚ï¼Œæ²¡çœ‹åˆ°ç¬¬äºŒå±‚ï¼Œå°‘çœ‹äº†ä¸ªcpu_srã€‚</p>
<p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œè¿™åˆæ˜¯ä¸ªå•¥ï¼Ÿè§‚å¯Ÿæˆ‘ä»¬çš„å‚è€ƒæ–‡ä»¶ï¼Œå†ä¸Šç½‘æŸ¥ä¸€æŸ¥ï¼Œæˆ‘ä»¬ä¼šåœ¨os_time.cç­‰æ–‡ä»¶é‡Œå‘ç°è¿™ä¸ªçš„å®šä¹‰(å¾ˆå¤šé‡Œé¢éƒ½æœ‰)</p>
<pre class="language-none"><code class="language-none">#if OS_CRITICAL_METHOD &#x3D;&#x3D; 3u                     &#x2F;* Allocate storage for CPU status register           *&#x2F;
    OS_CPU_SR  cpu_sr &#x3D; 0u;
#endif</code></pre>
<p>ä½†æ˜¯ç¼–è¯‘çš„æ—¶å€™æ²¡æœ‰æ‰¾åˆ°è¿™äº›çš„å®šä¹‰ï¼Œæ˜¾ç„¶æ˜¯å› ä¸ºæ²¡æœ‰å®šä¹‰OS_CRITICAL_METHODï¼Œå¯¹æˆ‘ä»¬åˆšåˆšåŠ è¿›å»çš„ä¸¤éƒ¨åˆ†ç¨ä½œä¿®æ”¹ï¼ŒåŠ å…¥OS_CRITICAL_METHODå®šä¹‰å³å¯ï¼Œé¡ºæ‰‹æŠŠäººå®¶çš„æ³¨é‡Šä¹ŸåŠ è¿›å»äº†</p>
<pre class="language-none"><code class="language-none">&#x2F;&#x2F;OS_CRITICAL_METHOD &#x3D; 1 :ç›´æ¥ä½¿ç”¨å¤„ç†å™¨çš„å¼€å…³ä¸­æ–­æŒ‡ä»¤æ¥å®ç°å® 
&#x2F;&#x2F;OS_CRITICAL_METHOD &#x3D; 2 :åˆ©ç”¨å †æ ˆä¿å­˜å’Œæ¢å¤CPUçš„çŠ¶æ€ 
&#x2F;&#x2F;OS_CRITICAL_METHOD &#x3D; 3 :åˆ©ç”¨ç¼–è¯‘å™¨æ‰©å±•åŠŸèƒ½è·å¾—ç¨‹åºçŠ¶æ€å­—ï¼Œä¿å­˜åœ¨å±€éƒ¨å˜é‡cpu_sr

#define  OS_CRITICAL_METHOD   3	 	&#x2F;&#x2F;è¿›å…¥ä¸´ç•Œæ®µçš„æ–¹æ³•

#if OS_CRITICAL_METHOD &#x3D;&#x3D; 3
#define  OS_ENTER_CRITICAL()  &#123;cpu_sr &#x3D; OS_CPU_SR_Save();&#125;
#define  OS_EXIT_CRITICAL()   &#123;OS_CPU_SR_Restore(cpu_sr);&#125;

OS_CPU_SR  OS_CPU_SR_Save(void);
void       OS_CPU_SR_Restore(OS_CPU_SR cpu_sr);
#endif</code></pre>
<p>ç»§ç»­ç¼–è¯‘ï¼ï¼å››ç§ç¼–è¯‘warningï¼ˆæœ‰ä¸€ä¸ªæ²¡æˆªå›¾ï¼Œåæ­£ä½ ç°åœ¨ä¸å‘ç°é©¬ä¸Šä¹Ÿå‘ç°äº†ï¼‰å’Œä¸€ç§é“¾æ¥error</p>
<p><img src="https://fffyutt.gitee.io/image_warehouse/ucosii1/image-20210309215209125.png" alt="image-20210309215209125" / loading="lazy"></p>
<p><img src="https://gitee.com/fffyutt/img/raw/blog/img/202202261612471.png" alt="image-20210309215219516" / loading="lazy"></p>
<p>è¿˜æ˜¯å…ˆå¤„ç†warningå§ï¼Œä¸‹é¢çš„é“¾æ¥erroråˆšåˆšå·²ç»å‡ºç°è¿‡äº†ä½†æ˜¯æˆ‘æ²¡æœ‰å¤„ç†</p>
<p>åœ¨os_cpu.håŠ å…¥å››ä¸ªå‡½æ•°çš„å®šä¹‰å³å¯è§£å†³warningï¼ŒåŠ å…¥éƒ¨åˆ†å¦‚ä¸‹</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token comment">//ä»»åŠ¡åˆ‡æ¢å®,ç”±æ±‡ç¼–å®ç°.</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name function">OS_TASK_SW</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token function">OSCtxSw</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>
<span class="token keyword">void</span>       <span class="token function">OSCtxSw</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span>       <span class="token function">OSIntCtxSw</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span>       <span class="token function">OSStartHighRdy</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>æ¥ä¸‹æ¥å¤„ç†linking errorï¼Œè§‚å¯Ÿä¸‹ï¼Œå…¨éƒ½æ˜¯ucos_ii.oå’Œåˆ«çš„æ–‡ä»¶é‡å¤å®šä¹‰äº†ï¼Œè¿›å»çœ‹çœ‹è¿™æ˜¯ä¸ªå•¥</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">OS_GLOBALS</span>                           <span class="token comment">/* Declare GLOBAL variables                              */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ucos_ii.h></span></span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>  <span class="token macro-name">OS_MASTER_FILE</span>                       <span class="token comment">/* Prevent the following files from including includes.h */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;os_core.c></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;os_flag.c></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;os_mbox.c></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;os_mem.c></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;os_mutex.c></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;os_q.c></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;os_sem.c></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;os_task.c></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;os_time.c></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;os_tmr.c></span></span>
	 	   	  		 			 	  </code></pre>
<p>è¿™å°±æ˜¯ä¹‹å‰æ‰€æœ‰çš„å¤´æ–‡ä»¶å•Šï¼Œç®€å•ç†è§£ä¸‹ï¼Œè¿™ä¸ªæ–‡ä»¶ä¸åº”è¯¥å‡ºç°åœ¨å·¥ç¨‹é‡Œï¼Œå€Ÿç”¨æˆ‘æŸ¥åˆ°çš„ä¸€å¥è¯ï¼š</p>
<p>æ–‡ä»¶/ucosii1.cåŒ…å«äº†æ‰€æœ‰å…¶å®ƒucosçš„æºæ–‡ä»¶, åªéœ€è¦ç¼–è¯‘å®ƒå°±å¯ä»¥äº†, å…¶å®ƒçš„å°±ä¸ç”¨ç¼–è¯‘äº†.  ä¹Ÿå¯ä»¥æŠŠ/ucosii1.cæ–‡ä»¶åˆ é™¤.</p>
<p>è€Œæˆ‘ä»¬æ˜¯ç›´æ¥ç”¨keilè¿›è¡Œç¼–è¯‘çš„ï¼Œå°±ï¼Œåˆ äº†å°±å¥½äº†ã€‚æ‰€ä»¥æˆ‘ä»¬æŠŠä»–åˆ äº†ï¼Œç»§ç»­ç¼–è¯‘</p>
<p><img src="https://gitee.com/fffyutt/img/raw/blog/img/202202261612381.png" alt="image-20210309222311740" / loading="lazy"></p>
<p>æ²¡æœ‰åŠ mainå‡½æ•°ï¼Œé‚£å°±åŠ ä¸Š</p>
<p>æ²¡æœ‰å®šä¹‰ä¸€ç³»åˆ—çš„hookå‡½æ•°ï¼Œé‚£å°±å…ˆæŠŠä¸Šé¢æåˆ°çš„ä¸€å †hookå’ŒOSTaskInit()åŠ åˆ°os_cpu_c.c(åˆ«é—®ä¸ºä»€ä¹ˆåŠ åˆ°è¿™é‡Œï¼Œåˆ«äººå°±æ˜¯è¿™ä¹ˆåŠ çš„ï¼Œå…¶å®åŠ åˆ°å“ªéƒ½å¯ä»¥ï¼Œçœ‹ä½ å¿ƒæƒ…)</p>
<p>åˆšåˆšæˆ‘ä»¬åŠ åˆ°os_cpu.hé‡Œé¢çš„ä¸€äº›å‡½æ•°åªæœ‰å®šä¹‰æ²¡æœ‰å®ç°ï¼Œé‚£å…ˆå†™ä¸ªcæŠŠè¿™äº›å®ç°äº†(å®é™…ä¸Šè¿™éƒ¨åˆ†æ˜¯ç”¨æ±‡ç¼–å®Œæˆçš„)</p>
<p>å¦å¤–ç°åœ¨ï¼ˆå…¶å®åœ¨ä¸€å¼€å§‹ï¼‰æˆ‘ä»¬è¦åŠ å…¥BSPéƒ¨åˆ†å†…å®¹äº†ï¼Œä¸»è¦åŒ…æ‹¬å¯åŠ¨æ–‡ä»¶ï¼Œå„ç§å¤´æ–‡ä»¶ï¼Œä»¥åŠä¸­æ–­å‡½æ•°çš„å®šä¹‰ç­‰ç­‰</p>
<p>ç»è¿‡æ•°æ¬¡ç¼–è¯‘æµ‹è¯•ï¼Œéœ€è¦åŒ…å«ä»¥ä¸‹æ–‡ä»¶ï¼ˆå…¶ä¸­æ–‡ä»¶æˆ‘ç”¨æ–‡ä»¶ååœ¨æˆ‘ç”µè„‘ä¸Šæœäº†ä¸€ä¸‹ï¼Œå‘ç°stm32cubeé‡Œæä¾›äº†å®Œæ•´çš„å¤´æ–‡ä»¶æ”¯æŒï¼Œç›´æ¥æ‰¾åˆ°ä¸¢è¿›å»å°±å¥½äº†ï¼‰</p>
<p><img src="https://gitee.com/fffyutt/img/raw/blog/img/202202261612226.png" alt="image-20210310003527737" / loading="lazy"></p>
<p>éœ€è¦åœ¨appæ–‡ä»¶å¤¹ä¸‹æ·»åŠ main.cï¼Œå†…å®¹å¦‚ä¸‹</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>

<span class="token punctuation">&#125;</span>
</code></pre>
<p>éœ€è¦åœ¨os_cpu.hé‡Œæ·»åŠ æœ‰å…³OS_TASK_SW() çš„å®šä¹‰ï¼Œå¦‚ä¸‹</p>
<pre class="language-none"><code class="language-none">#define  OS_TASK_SW()         OSCtxSw()</code></pre>
<p>éœ€è¦åœ¨portæ–‡ä»¶å¤¹ä¸‹æ·»åŠ æ±‡ç¼–æ–‡ä»¶os_cpu_a.asmï¼Œå†…å®¹å¦‚ä¸‹ã€‚å…¶ä¸­ï¼ŒBX  LR ç”¨é€”ä¸ renturn 0ï¼›ç›¸åŒï¼Œç”¨äºå‡½æ•°è¿”å›ï¼Œåç»­åœ¨è¡¥å……ç¡¬ä»¶éƒ¨åˆ†å‡½æ•°æ—¶ä¼šæœ‰å¯¹armå¤„ç†å™¨ç¡¬ä»¶çŸ¥è¯†çš„è¡¥å……ï¼Œè¯»è€…ä¹Ÿå¯ä»¥è‡ªè¡Œæœç´¢ã€‚</p>
<pre class="language-none"><code class="language-none">OS_CPU_SR_Save
    BX LR

OS_CPU_SR_Restore
    BX LR

OSStartHighRdy
    BX LR

OSCtxSw
    BX LR

OSIntCtxSw
    BX LR</code></pre>
<p>éœ€è¦åœ¨portæ–‡ä»¶å¤¹ä¸‹æ·»åŠ cæ–‡ä»¶os_cpu_c.cï¼Œå†…å®¹å¦‚ä¸‹</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"includes.h"</span></span>

<span class="token keyword">void</span>  <span class="token function">OSInitHookBegin</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span>  <span class="token function">OSInitHookEnd</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span>  <span class="token function">OSTaskCreateHook</span> <span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span>ptcb<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span>  <span class="token function">OSTaskDelHook</span> <span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span>ptcb<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span>  <span class="token function">OSTaskIdleHook</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span>  <span class="token function">OSTaskStatHook</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>

<span class="token punctuation">&#125;</span>

OS_STK <span class="token operator">*</span><span class="token function">OSTaskStkInit</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>task<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>p_arg<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token constant">NULL</span><span class="token operator">*</span>p_arg<span class="token punctuation">,</span> OS_STK <span class="token operator">*</span>ptos<span class="token punctuation">,</span> INT16U opt<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    OS_STK<span class="token operator">*</span> stk<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> stk<span class="token punctuation">;</span> 
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span>  <span class="token function">OSTaskSwHook</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span>  <span class="token function">OSTCBInitHook</span> <span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span>ptcb<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span>  <span class="token function">OSTimeTickHook</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>

<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">OSTaskReturnHook</span><span class="token punctuation">(</span>OS_TCB <span class="token operator">*</span>ptcb<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>

<span class="token punctuation">&#125;</span>
</code></pre>
<p>å…¶å®å°±æ˜¯ä¸Šé¢æŠ¥çš„ç¼ºä»€ä¹ˆå‡½æ•°è¡¥ä»€ä¹ˆå‡½æ•°è€Œå·²ï¼Œç»§ç»­ç¼–è¯‘ï¼ï¼</p>
<p><img src="https://gitee.com/fffyutt/img/raw/blog/img/202202261612498.png" alt="image-20210310010513491" / loading="lazy"></p>
<p>è¿™æ¬¡ï¼Œemmmï¼Œçœ‹ä¸æ‡‚ï¼Œè‡³å°‘çŸ¥é“æ˜¯åœ¨æ±‡ç¼–æ–‡ä»¶é‡Œå‡ºé—®é¢˜äº†ï¼Œå»æŸ¥ä¸‹ç¿»ä¸€ä¸‹å…ˆï¼Œå¤§æ„å°±æ˜¯æœ‰ä¸ªlabelä»–ä¸è®¤è¯†ï¼Œç”¨æŸ¥åˆ°çš„åŸè¯æ¥è¯´ï¼š</p>
<p>å‡ºç°è¿™ä¸ªé—®é¢˜çš„ï¼ŒåŸºæœ¬ä¸Šæ˜¯å› ä¸ºä½¿ç”¨æ±‡ç¼–çš„æ ¼å¼ä¸å¯¹</p>
<p>é‚£å°±ï¼Œè¦å…ˆçœ‹ä¸‹è¿™ä¸ªæ±‡ç¼–è¯­è¨€çš„æ ¼å¼äº†ï¼Œè”æƒ³åˆ°ä¸Šå­¦æœŸå­¦çš„æ±‡ç¼–å¼€å§‹è¦å®šä¹‰ä»€ä¹ˆä»£ç æ®µæ•°æ®æ®µå †æ ˆæ®µä¹‹ç±»çš„ï¼Œä¼°è®¡æ˜¯å°‘äº†è¿™ä¸ªã€‚</p>
<p>åæ­£å°±ï¼ŒåŠ äº†è¿™ä¸ªåœ¨æ±‡ç¼–æ–‡ä»¶çš„å¼€å§‹è¿™ä¸ªï¼Œæœ‰å…³å †æ ˆåˆ†æ®µå¯¹é½çš„å®šä¹‰ï¼Œä»¥åŠæŒ‡ä»¤é›†ç­‰çš„å®šä¹‰</p>
<pre class="language-none"><code class="language-none">PRESERVE8 

AREA    |.text|, CODE, READONLY
      THUMB </code></pre>
<p>ç»§ç»­build</p>
<p><img src="https://gitee.com/fffyutt/img/raw/blog/img/202202261612045.png" alt="image-20210310011115486" / loading="lazy"></p>
<p>å°‘ä¸ªendï¼Œé‚£å°±åŠ ä¸Š</p>
<p>åé¢æ²¡æœ‰å®šä¹‰è¿™ä¸ªå‡½æ•°ï¼Ÿå¯æ˜¯æˆ‘ä»¬æ˜æ˜å·²ç»æŠŠè¿™äº›åŠ è¿›å»äº†å•Šï¼</p>
<p>å®é™…ä¸Šæ˜¯å› ä¸ºæ²¡æœ‰æ·»åŠ ç±»ä¼¼cè¯­è¨€ä¸­includeçš„ä¸€æ ·çš„ä¸œè¥¿ï¼Œæ²¡èƒ½å°†åœ¨æ±‡ç¼–æ–‡ä»¶ä¸­å®šä¹‰çš„å‡½æ•°å’Œos_core.oé“¾æ¥èµ·æ¥</p>
<p>åæ­£å°±ï¼ŒåŠ äº†å¦‚ä¸‹å†…å®¹åœ¨æ±‡ç¼–çš„å¼€å§‹ï¼Œç”¨äºè¡¨ç¤ºå¤–éƒ¨å®šä¹‰çš„å‡½æ•°</p>
<pre class="language-none"><code class="language-none">      EXPORT  OSStartHighRdy               
      EXPORT  OSCtxSw
      EXPORT  OSIntCtxSw
EXPORT  OS_CPU_SR_Save
  	EXPORT  OS_CPU_SR_Restore </code></pre>
<p>ç„¶åã€‚ã€‚ohhhhhhhhæˆåŠŸäº†ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼</p>
<p><img src="https://gitee.com/fffyutt/img/raw/blog/img/202202261612697.png" alt="image-20210310011509362" / loading="lazy"></p>
<p>è¿™é‡Œè¡¥ä¸€å¥ï¼Œæˆ‘ä»¬éœ€è¦åœ¨é­”æœ¯æ£’çš„c/c++é€‰é¡¹ä¸­åŠ å…¥ä¸¤ä¸ªå®å®šä¹‰ç”¨äºå¸®åŠ©ç¼–è¯‘</p>
<pre class="language-none"><code class="language-none">STM32F401xx</code></pre>
<p>è¿™é‡Œçš„ç¬¬ä¸€ä¸ªå®æ˜¯ç”¨ä½œå¸®åŠ©å¯åŠ¨æ–‡ä»¶ç¡®å®šæ¿å­ç±»å‹çš„ã€‚</p>
<h3 id="å·¥ç¨‹éªŒè¯"><a class="markdownIt-Anchor" href="#å·¥ç¨‹éªŒè¯"></a> å·¥ç¨‹éªŒè¯</h3>
<p>æ¥ä¸‹æ¥çš„éƒ¨åˆ†å¹¶ä¸åœ¨å­¦ä¹ è®¡åˆ’å†…ï¼Œåªæ˜¯ä¸ºäº†èƒ½å¤ŸéªŒè¯ä¸‹å·¥ç¨‹å»ºç«‹æœ‰æ— é—®é¢˜ï¼Œå¾ˆå¤šä¸œè¥¿ä¸ä¼šè¿‡å¤šè§£é‡Šï¼Œç›´æ¥ç›´æ¥è·³è¿‡ä¹Ÿè¡Œã€‚</p>
<p>å› ä¸ºä¹ŸåŒ…å«äº†è‡ªå·±å¾ˆå¤šçš„è¯•é”™è¿‡ç¨‹ï¼Œä¸å»ºè®®æ›´ç€åšï¼Œå»ºè®®å…ˆçœ‹å®Œã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å¼€å§‹ç‚¹ç¯ï¼Œç”±äºæ‡’ï¼Œæˆ‘ä»¬ç›´æ¥æŠŠstmå®˜æ–¹æä¾›çš„libåŠ å…¥å·¥ç¨‹ï¼ˆå…¶ä¸­stm32f4xx_fmc.cå’Œstm32f4xx_fsmc.cä¸èƒ½åŠ å…¥å·¥ç¨‹ä¼šæœ‰æœªå®šä¹‰çš„å‡½æ•°ï¼Œä¸”æˆ‘æ²¡æ‰¾åˆ°ä»–çš„å®šä¹‰åœ¨ä»€ä¹ˆä½ç½®ï¼‰ï¼Œå¹¶åœ¨BSP/incé‡Œæ·»åŠ æ‰€éœ€çš„å¤´æ–‡ä»¶ï¼Œæ–‡ä»¶å¦‚ä¸‹</p>
<p><img src="https://gitee.com/fffyutt/img/raw/blog/img/202202261612158.png" alt="image-20210310212233524" / loading="lazy"></p>
<p>å¹¶åœ¨é­”æœ¯æ£’c\c++ä¸­æ·»åŠ ä¸€ä¸ªå®</p>
<pre class="language-none"><code class="language-none">STM32F401xx,USE_STDPERIPH_DRIVER</code></pre>
<p>ç¬¬äºŒä¸ªæ˜¯å¯ç”¨å®˜æ–¹åº“çš„ï¼Œåç»­å¯èƒ½ä¼šæ”¾å¼ƒä½¿ç”¨å®˜æ–¹åº“ï¼Œè®°å¾—æŠŠç¬¬äºŒä¸ªå®åˆ æ‰ã€‚</p>
<p>ä¸»å‡½æ•°å¦‚ä¸‹</p>
<pre class="language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"../CONFIG/includes.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"misc.h"</span></span>


<span class="token comment">//è®¾ç½®ä»»åŠ¡ä¼˜å…ˆçº§</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LED_TASK_PRIO</span>			<span class="token expression"><span class="token number">7</span></span></span>
<span class="token comment">//è®¾ç½®ä»»åŠ¡å †æ ˆå¤§å°</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LED_STK_SIZE</span>			<span class="token expression"><span class="token number">128</span></span></span>
<span class="token comment">//ä»»åŠ¡å †æ ˆ</span>
OS_STK LED_TASK_STK<span class="token punctuation">[</span>LED_STK_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">//ä»»åŠ¡å‡½æ•°</span>
<span class="token keyword">void</span> <span class="token function">LED_task</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pdata<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>

    u32 reload<span class="token punctuation">;</span>
    u8 SYSCLK <span class="token operator">=</span> <span class="token number">84</span><span class="token punctuation">;</span>
    <span class="token function">SysTick_CLKSourceConfig</span><span class="token punctuation">(</span>SysTick_CLKSource_HCLK_Div8<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    reload<span class="token operator">=</span>SYSCLK<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">;</span>						<span class="token comment">//æ¯ç§’é’Ÿçš„è®¡æ•°æ¬¡æ•° å•ä½ä¸ºM	   </span>
    reload<span class="token operator">*=</span><span class="token number">1000000</span><span class="token operator">/</span>OS_TICKS_PER_SEC<span class="token punctuation">;</span>	<span class="token comment">//æ ¹æ®delay_ostickspersecè®¾å®šæº¢å‡ºæ—¶é—´</span>
						<span class="token comment">//reloadä¸º24ä½å¯„å­˜å™¨,æœ€å¤§å€¼:16777216,åœ¨168Mä¸‹,çº¦åˆ0.7989så·¦å³	</span>
    SysTick<span class="token operator">-></span>CTRL<span class="token operator">|=</span>SysTick_CTRL_TICKINT_Msk<span class="token punctuation">;</span>   	<span class="token comment">//å¼€å¯SYSTICKä¸­æ–­</span>
    SysTick<span class="token operator">-></span>LOAD<span class="token operator">=</span>reload<span class="token punctuation">;</span> 				<span class="token comment">//æ¯1/delay_ostickspersecç§’ä¸­æ–­ä¸€æ¬¡	</span>
    SysTick<span class="token operator">-></span>CTRL<span class="token operator">|=</span>SysTick_CTRL_ENABLE_Msk<span class="token punctuation">;</span> 	<span class="token comment">//å¼€å¯SYSTICK    </span>
    <span class="token function">OSInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">OSTaskCreate</span><span class="token punctuation">(</span>LED_task<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token punctuation">(</span>OS_STK<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>LED_TASK_STK<span class="token punctuation">[</span>LED_STK_SIZE<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>LED_TASK_PRIO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">OSStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> <span class="token function">LED_task</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>pdata<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
       GPIO_InitTypeDef  GPIO_InitStructure<span class="token punctuation">;</span>
      
       <span class="token function">RCC_AHB1PeriphClockCmd</span><span class="token punctuation">(</span>RCC_AHB1Periph_GPIOA<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>   
       GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_5<span class="token punctuation">;</span>
       GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_OUT<span class="token punctuation">;</span>
       GPIO_InitStructure<span class="token punctuation">.</span>GPIO_OType <span class="token operator">=</span>GPIO_OType_PP<span class="token punctuation">;</span>
       GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span>GPIO_Speed_100MHz<span class="token punctuation">;</span>
       GPIO_InitStructure<span class="token punctuation">.</span>GPIO_PuPd <span class="token operator">=</span>GPIO_PuPd_NOPULL<span class="token punctuation">;</span>
      
       <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span><span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span>GPIO_Pin_5<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
       <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
       <span class="token punctuation">&#123;</span>              
              <span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span>GPIO_Pin_5<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">&#125;</span>     
<span class="token punctuation">&#125;</span></code></pre>
<p>è¿™ä¸ªæ—¶å€™ï¼Œç¼–è¯‘è¿‡äº†ï¼Œä¸‹è½½è¿›æ¿å­ï¼Œæ¯«æ— ååº”ã€‚ã€‚ï¼ˆä»£ç æ‹¿å»æˆ‘ç§»æ¤å¥½çš„ç³»ç»Ÿè¯•è¿‡çš„ï¼Œæ˜¯æ²¡é—®é¢˜çš„ï¼‰</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯ç—›è‹¦çš„å®éªŒæ—¶åˆ»ï¼Œä»ç°åœ¨å¼€å§‹ï¼Œå°±å‡ ä¹æ²¡æœ‰buildingçš„æŠ¥é”™å¯ä»¥å‚è€ƒäº†ï¼Œå› ä¸ºæˆ‘ä¹‹å‰å·²ç»æœ‰äº†ä¸€ä¸ªç…§æ¬åˆ«äººç§»æ¤å¥½çš„å·¥ç¨‹ï¼Œæ‰€ä»¥ä¼šç®€å•ä¸€ç‚¹ï¼Œä¸ç„¶ï¼Œæ€ä¹ˆæ­»éƒ½ä¸çŸ¥é“çš„</p>
<p>ç ”ç©¶äº†ä¸‹OSInit()å’ŒOSStart()çš„é€»è¾‘ï¼Œå‘ç°ç”¨åˆ°äº†æ±‡ç¼–é‡Œå®šä¹‰çš„5ä¸ªå‡½æ•°ï¼Œè¿˜æ–°å¢ä¸¤ä¸ªå‡½æ•°ï¼Œä¿®æ”¹å¦‚ä¸‹</p>
<pre class="language-none"><code class="language-none">		IMPORT  OSRunning               ; External references
        IMPORT  OSPrioCur
        IMPORT  OSPrioHighRdy
        IMPORT  OSTCBCur
        IMPORT  OSTCBHighRdy
        IMPORT  OSIntNesting
        IMPORT  OSIntExit
        IMPORT  OSTaskSwHook
           
        EXPORT  OSStartHighRdy               
        EXPORT  OSCtxSw
        EXPORT  OSIntCtxSw
		EXPORT  OS_CPU_SR_Save                                      ; Functions declared in this file
    	EXPORT  OS_CPU_SR_Restore       
        EXPORT  OS_CPU_PendSVHandler
        	
     
NVIC_INT_CTRL   	EQU     0xE000ED04  
NVIC_SYSPRI2    	EQU     0xE000ED22  
NVIC_PENDSV_PRI 	EQU         0xFFFF  
                                        
NVIC_PENDSVSET  	EQU     0x10000000  

		PRESERVE8 
		
		AREA    |.text|, CODE, READONLY
        THUMB 

OS_CPU_SR_Save
		MRS     R0, PRIMASK  	
		CPSID   I				
		BX      LR			    

OS_CPU_SR_Restore
		MSR     PRIMASK, R0	   	
		BX      LR				

OSStartHighRdy
        LDR     R4, &#x3D;NVIC_SYSPRI2      ; set the PendSV exception priority
        LDR     R5, &#x3D;NVIC_PENDSV_PRI
        STR     R5, [R4]

        MOV     R4, #0                 ; set the PSP to 0 for initial context switch call
        MSR     PSP, R4

        LDR     R4, &#x3D;OSRunning         ; OSRunning &#x3D; TRUE
        MOV     R5, #1
        STRB    R5, [R4]

                                       
        LDR     R4, &#x3D;NVIC_INT_CTRL     ;rigger the PendSV exception (causes context switch)
        LDR     R5, &#x3D;NVIC_PENDSVSET
        STR     R5, [R4]

        CPSIE   I                      ;enable interrupts at processor level
OSStartHang
        B       OSStartHang            ;should never get here
	
OSCtxSw
		PUSH    &#123;R4, R5&#125;
        LDR     R4, &#x3D;NVIC_INT_CTRL  	;PendSV (causes context switch)
        LDR     R5, &#x3D;NVIC_PENDSVSET
        STR     R5, [R4]
		POP     &#123;R4, R5&#125;
        BX      LR

OSIntCtxSw
		PUSH    &#123;R4, R5&#125;
        LDR     R4, &#x3D;NVIC_INT_CTRL      ;PendSV (causes context switch)
        LDR     R5, &#x3D;NVIC_PENDSVSET
        STR     R5, [R4]
		POP     &#123;R4, R5&#125;
        BX      LR
        NOP

OS_CPU_PendSVHandler
		CPSID   I                                         ; Prevent interruption during context switch
		MRS     R0, PSP                                             ; PSP is process stack pointer
		CBZ     R0, OS_CPU_PendSVHandler_nosave		                    ; Skip register save the first time
		
		;Is the task using the FPU context? If so, push high vfp registers.
		TST 	R14, #0x10
		IT 		EQ
		VSTMDBEQ R0!, &#123;S16-S31&#125; 
		
		SUBS    R0, R0, #0x20                              ; Save remaining regs r4-11 on process stack
		STM     R0, &#123;R4-R11&#125;
		
		LDR     R1, &#x3D;OSTCBCur                                       ; OSTCBCur-&gt;OSTCBStkPtr &#x3D; SP;
		LDR     R1, [R1]
		STR     R0, [R1]                                            ; R0 is SP of process being switched out

                                             ; At this point, entire context of process has been saved
OS_CPU_PendSVHandler_nosave
		PUSH    &#123;R14&#125;                                               ; Save LR exc_return value
		LDR     R0, &#x3D;OSTaskSwHook                                   ; OSTaskSwHook();
		BLX     R0
		POP     &#123;R14&#125; 

		LDR     R0, &#x3D;OSPrioCur                                      ; OSPrioCur &#x3D; OSPrioHighRdy;
		LDR     R1, &#x3D;OSPrioHighRdy
		LDRB    R2, [R1]
		STRB    R2, [R0]

		LDR     R0, &#x3D;OSTCBCur                                       ; OSTCBCur  &#x3D; OSTCBHighRdy;
		LDR     R1, &#x3D;OSTCBHighRdy
		LDR     R2, [R1]
		STR     R2, [R0]

		LDR     R0, [R2]                            ; R0 is new process SP; SP &#x3D; OSTCBHighRdy-&gt;OSTCBStkPtr;
		LDM     R0, &#123;R4-R11&#125;                                        ; Restore r4-11 from new process stack
		ADDS    R0, R0, #0x20

		;Is the task using the FPU context? If so, push high vfp registers.
		TST 	R14, #0x10
		IT 		EQ
		VLDMIAEQ R0!, &#123;S16-S31&#125; 
		
		MSR     PSP, R0                                             ; Load PSP with new process SP
		ORR     LR, LR, #0x04                                  ; Ensure exception return uses process stack
		CPSIE   I
		BX      LR                            ; Exception return will restore remaining context
		NOP
		end</code></pre>
<p>ç»è¿‡æµ‹è¯•ï¼Œå°†å…¶ä¸­çš„ä»»ä¸€æ–‡ä»¶åˆ é™¤ç¨‹åºéƒ½æ— æ³•æ­£å¸¸è¿è¡Œ(å¯èƒ½æ˜¯æˆ‘ä¸ä¼šè¡¨ç¤ºæ±‡ç¼–çš„å‡½æ•°å¦‚ä½•ç»“æŸ)ï¼Œä½†æ˜¯å¯ä»¥å°†OS_CPU_PendSVHandlerçš„å†…å®¹åˆ å»ï¼ŒåŸå› ä¸ºæ­¤å‡½æ•°çš„ä»»åŠ¡ä¸ºä¿å­˜ä¸Šæ–‡ï¼Œåœ¨é¦–æ¬¡è°ƒç”¨æ—¶çš„å”¯ä¸€ä½œç”¨æ˜¯è°ƒç”¨OS_CPU_PendSVHandler_nosaveï¼Œè€ŒOS_CPU_PendSVHandler_nosaveæ­£å¥½åœ¨OS_CPU_PendSVHandlerä¸‹é¢ï¼Œå¦‚æœå°†OS_CPU_PendSVHandlerå†…å®¹åˆ å»ï¼Œå‡½æ•°å°†ç»§ç»­æ‰§è¡ŒOS_CPU_PendSVHandler_nosaveï¼Œå®é™…ä¸Šæ­£ç¡®ï¼Œä½†æ˜¯é€»è¾‘ä¸Šé”™è¯¯ã€‚</p>
<p>ç„¶åä¸Šé¢ä½œåºŸï¼Œç ”ç©¶äº†ä¸€ä¸‹å‡½æ•°çš„ä½œç”¨ï¼Œå…¶ä¸­OS_CPU_SR_Saveå’ŒOS_CPU_SR_RESTOREæ˜¯ç”¨ä½œè¿›å‡ºä¸´ç•Œæ®µçš„ï¼Œæˆ‘ä»¬ç®€å•çš„ç¨‹åºä¸éœ€è¦è¿™äº›ï¼Œç›´æ¥æ”¹æˆç©ºå‡½æ•°ä¹Ÿä¸ä¼šå‡ºé—®é¢˜ï¼ŒåŒç†å¯ä»¥ä¿®æ”¹OSCtxSwä¸OSIntCtxSwï¼Œå› ä¸ºæ²¡æœ‰ä»»åŠ¡åˆ‡æ¢ï¼Œè€ŒOSStartHighRdyæ˜¯åœ¨ç³»ç»Ÿåˆå§‹åŒ–æ—¶æ‰¾åˆ°æœ€é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡ç”¨ï¼Œå…¶ä¸­ä¼šè°ƒç”¨OS_CPU_PendSVHandlerï¼Œå› ä¸ºæ˜¯ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œç›´æ¥è¿›å…¥OS_CPU_PendSVHandler_nosaveåˆ‡æ¢ä¸‹æ–‡ï¼Œæ‰€ä»¥æœ€ç»ˆä¿ç•™äº†ä¸¤æ®µå‡½æ•°ç”¨äºæœ€å°ç³»ç»Ÿçš„éªŒè¯ï¼ˆå…¶å®æ˜¯èƒ½åŠ›ä¸è¶³ï¼Œå†æ”¹ä¸‹å»å¯¹ä»£ç ç»“æ„çš„ä¿®æ”¹å°±å¤ªå¤§äº†ï¼Œä¸å€¼å¾—äº†ï¼‰</p>
<p>å°†æ±‡ç¼–æ–‡ä»¶ä¿®æ”¹ä¸ºä¸‹</p>
<pre class="language-none"><code class="language-none">		IMPORT  OSRunning               ; External references
        IMPORT  OSPrioCur
        IMPORT  OSPrioHighRdy
        IMPORT  OSTCBCur
        IMPORT  OSTCBHighRdy
        IMPORT  OSIntNesting
        IMPORT  OSIntExit
        IMPORT  OSTaskSwHook
           
        EXPORT  OSStartHighRdy               
        EXPORT  OSCtxSw
        EXPORT  OSIntCtxSw
		EXPORT  OS_CPU_SR_Save                                      ; Functions declared in this file
    	EXPORT  OS_CPU_SR_Restore       
        EXPORT  OS_CPU_PendSVHandler
        	
     
NVIC_INT_CTRL   	EQU     0xE000ED04  ; ä¸­æ–­æ§åˆ¶å¯„å­˜å™¨
NVIC_SYSPRI2    	EQU     0xE000ED22  ; ç³»ç»Ÿä¼˜å…ˆçº§å¯„å­˜å™¨(2)
NVIC_PENDSV_PRI 	EQU         0xFFFF  ; PendSVä¸­æ–­å’Œç³»ç»ŸèŠ‚æ‹ä¸­æ–­
                                        ; (éƒ½ä¸ºæœ€ä½ï¼Œ0xff).
NVIC_PENDSVSET  	EQU     0x10000000  ; è§¦å‘è½¯ä»¶ä¸­æ–­çš„å€¼.


		PRESERVE8 
		
		AREA    |.text|, CODE, READONLY
        THUMB 

OS_CPU_SR_Save
    BX      LR			    ;è¿”å›

OS_CPU_SR_Restore
    BX      LR				;è¿”å›

OSStartHighRdy
        LDR     R4, &#x3D;NVIC_SYSPRI2      ; set the PendSV exception priority
        LDR     R5, &#x3D;NVIC_PENDSV_PRI
        STR     R5, [R4]

        MOV     R4, #0                 ; set the PSP to 0 for initial context switch call
        MSR     PSP, R4

        LDR     R4, &#x3D;OSRunning         ; OSRunning &#x3D; TRUE
        MOV     R5, #1
        STRB    R5, [R4]

                                       ;åˆ‡æ¢åˆ°æœ€é«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡
        LDR     R4, &#x3D;NVIC_INT_CTRL     ;rigger the PendSV exception (causes context switch)
        LDR     R5, &#x3D;NVIC_PENDSVSET
        STR     R5, [R4]

        CPSIE   I                      ;enable interrupts at processor level
  
OSCtxSw
        BX      LR

OSIntCtxSw
        BX      LR

OS_CPU_PendSVHandler

OS_CPU_PendSVHandler_nosave
    LDR     R0, &#x3D;OSPrioCur                                      ; OSPrioCur &#x3D; OSPrioHighRdy;
    LDR     R1, &#x3D;OSPrioHighRdy
    LDRB    R2, [R1]
    STRB    R2, [R0]

    LDR     R0, &#x3D;OSTCBCur                                       ; OSTCBCur  &#x3D; OSTCBHighRdy;
    LDR     R1, &#x3D;OSTCBHighRdy
    LDR     R2, [R1]
    STR     R2, [R0]

    LDR     R0, [R2]                                            ; R0 is new process SP; SP &#x3D; OSTCBHighRdy-&gt;OSTCBStkPtr;
    LDM     R0, &#123;R4-R11&#125;                                        ; Restore r4-11 from new process stack
    ADDS    R0, R0, #0x20

	;Is the task using the FPU context? If so, push high vfp registers.
	TST 	R14, #0x10
	IT 		EQ
	VLDMIAEQ R0!, &#123;S16-S31&#125; 
		
	MSR     PSP, R0                                             ; Load PSP with new process SP
    ORR     LR, LR, #0x04                                       ; Ensure exception return uses process stack
    CPSIE   I
    BX      LR                                                  ; Exception return will restore remaining context
	NOP
    end  </code></pre>
<p>æ­¤å¤–éœ€è¦åœ¨os_cpu_c.cå†…è¡¥å……OSTaskStkInit(),ç»è¿‡æµ‹è¯•åˆ å»ä¸è¡Œï¼Œè¯¥å‡½æ•°çš„ä½œç”¨ä¸ºåˆå§‹åŒ–ä»»åŠ¡å †æ ˆï¼Œæ¨¡æ‹Ÿç¬¬ä¸€æ¬¡å‹æ ˆï¼Œå°†å¯„å­˜å™¨åˆå§‹åŒ–ï¼Œä¸å¾—åˆ é™¤ã€‚</p>
<pre class="language-none"><code class="language-none">OS_STK *OSTaskStkInit (void (*task)(void *p_arg), void *p_arg, OS_STK *ptos, INT16U opt)
&#123;
    OS_STK *stk;

    (void)opt;                                   &#x2F;* &#39;opt&#39; is not used, prevent warning                 *&#x2F;
    stk       &#x3D; ptos;                            &#x2F;* Load stack pointer                                 *&#x2F;

#if (__FPU_PRESENT&#x3D;&#x3D;1)&amp;&amp;(__FPU_USED&#x3D;&#x3D;1)	
	*(--stk) &#x3D; (INT32U)0x00000000L; &#x2F;&#x2F;No Name Register  
	*(--stk) &#x3D; (INT32U)0x00001000L; &#x2F;&#x2F;FPSCR
	*(--stk) &#x3D; (INT32U)0x00000015L; &#x2F;&#x2F;s15
	*(--stk) &#x3D; (INT32U)0x00000014L; &#x2F;&#x2F;s14
	*(--stk) &#x3D; (INT32U)0x00000013L; &#x2F;&#x2F;s13
	*(--stk) &#x3D; (INT32U)0x00000012L; &#x2F;&#x2F;s12
	*(--stk) &#x3D; (INT32U)0x00000011L; &#x2F;&#x2F;s11
	*(--stk) &#x3D; (INT32U)0x00000010L; &#x2F;&#x2F;s10
	*(--stk) &#x3D; (INT32U)0x00000009L; &#x2F;&#x2F;s9
	*(--stk) &#x3D; (INT32U)0x00000008L; &#x2F;&#x2F;s8
	*(--stk) &#x3D; (INT32U)0x00000007L; &#x2F;&#x2F;s7
	*(--stk) &#x3D; (INT32U)0x00000006L; &#x2F;&#x2F;s6
	*(--stk) &#x3D; (INT32U)0x00000005L; &#x2F;&#x2F;s5
	*(--stk) &#x3D; (INT32U)0x00000004L; &#x2F;&#x2F;s4
	*(--stk) &#x3D; (INT32U)0x00000003L; &#x2F;&#x2F;s3
	*(--stk) &#x3D; (INT32U)0x00000002L; &#x2F;&#x2F;s2
	*(--stk) &#x3D; (INT32U)0x00000001L; &#x2F;&#x2F;s1
	*(--stk) &#x3D; (INT32U)0x00000000L; &#x2F;&#x2F;s0
#endif
                                                 &#x2F;* Registers stacked as if auto-saved on exception    *&#x2F;
    *(stk)    &#x3D; (INT32U)0x01000000L;             &#x2F;* xPSR                                               *&#x2F;
    *(--stk)  &#x3D; (INT32U)task;                    &#x2F;* Entry Point                                        *&#x2F;
    *(--stk)  &#x3D; (INT32U)OS_TaskReturn;           &#x2F;* R14 (LR) (init value will cause fault if ever used)*&#x2F;
    *(--stk)  &#x3D; (INT32U)0x12121212L;             &#x2F;* R12                                                *&#x2F;
    *(--stk)  &#x3D; (INT32U)0x03030303L;             &#x2F;* R3                                                 *&#x2F;
    *(--stk)  &#x3D; (INT32U)0x02020202L;             &#x2F;* R2                                                 *&#x2F;
    *(--stk)  &#x3D; (INT32U)0x01010101L;             &#x2F;* R1                                                 *&#x2F;
    *(--stk)  &#x3D; (INT32U)p_arg;                   &#x2F;* R0 : argument                                      *&#x2F;

#if (__FPU_PRESENT&#x3D;&#x3D;1)&amp;&amp;(__FPU_USED&#x3D;&#x3D;1)	
	*(--stk) &#x3D; (INT32U)0x00000031L; &#x2F;&#x2F;s31
	*(--stk) &#x3D; (INT32U)0x00000030L; &#x2F;&#x2F;s30
	*(--stk) &#x3D; (INT32U)0x00000029L; &#x2F;&#x2F;s29
	*(--stk) &#x3D; (INT32U)0x00000028L; &#x2F;&#x2F;s28
	*(--stk) &#x3D; (INT32U)0x00000027L; &#x2F;&#x2F;s27
	*(--stk) &#x3D; (INT32U)0x00000026L; &#x2F;&#x2F;s26	
	*(--stk) &#x3D; (INT32U)0x00000025L; &#x2F;&#x2F;s25
	*(--stk) &#x3D; (INT32U)0x00000024L; &#x2F;&#x2F;s24
	*(--stk) &#x3D; (INT32U)0x00000023L; &#x2F;&#x2F;s23
	*(--stk) &#x3D; (INT32U)0x00000022L; &#x2F;&#x2F;s22
	*(--stk) &#x3D; (INT32U)0x00000021L; &#x2F;&#x2F;s21
	*(--stk) &#x3D; (INT32U)0x00000020L; &#x2F;&#x2F;s20
	*(--stk) &#x3D; (INT32U)0x00000019L; &#x2F;&#x2F;s19
	*(--stk) &#x3D; (INT32U)0x00000018L; &#x2F;&#x2F;s18
	*(--stk) &#x3D; (INT32U)0x00000017L; &#x2F;&#x2F;s17
	*(--stk) &#x3D; (INT32U)0x00000016L; &#x2F;&#x2F;s16
#endif
		
                                                &#x2F;* Remaining registers saved on process stack         *&#x2F;
    *(--stk)  &#x3D; (INT32U)0x11111111L;             &#x2F;* R11                                                *&#x2F;
    *(--stk)  &#x3D; (INT32U)0x10101010L;             &#x2F;* R10                                                *&#x2F;
    *(--stk)  &#x3D; (INT32U)0x09090909L;             &#x2F;* R9                                                 *&#x2F;
    *(--stk)  &#x3D; (INT32U)0x08080808L;             &#x2F;* R8                                                 *&#x2F;
    *(--stk)  &#x3D; (INT32U)0x07070707L;             &#x2F;* R7                                                 *&#x2F;
    *(--stk)  &#x3D; (INT32U)0x06060606L;             &#x2F;* R6                                                 *&#x2F;
    *(--stk)  &#x3D; (INT32U)0x05050505L;             &#x2F;* R5                                                 *&#x2F;
    *(--stk)  &#x3D; (INT32U)0x04040404L;             &#x2F;* R4                                                 *&#x2F;

    return (stk);
&#125;</code></pre>
<p>ä¸ºäº†ç¡®ä¿systickæ­£å¸¸è¿ä½œ,æˆ‘ä»¬éœ€è¦å°†æ±‡ç¼–ä¸­å®šä¹‰çš„ä¸­æ–­å‡½æ•°ä¸åœ¨startup_stm32f401xx.så®šä¹‰çš„ä¸­æ–­è”ç³»èµ·æ¥ï¼Œæœ‰ä¸¤ä¸ªæ–¹æ¡ˆ</p>
<p>æ–¹æ³•ä¸€ï¼ˆæ¯”è¾ƒéº»çƒ¦ä½†æ˜¯æ¯”è¾ƒå®¹æ˜“ç†è§£ä¸­æ–­çš„å«ä¹‰ï¼‰:</p>
<ol>
<li>å°†å¯åŠ¨æ–‡ä»¶ä¸­startup_stm32f401xx.sçš„æ‰€æœ‰â€œPendSV_Handlerâ€å’Œâ€œSysTick_Handlerâ€ï¼Œæ›¿æ¢æˆâ€œOS_CPU_PendSVHandlerâ€å’Œâ€œOS_CPU_SysTickHandlerâ€</li>
<li>å°†stm32f4xx_it.cæ–‡ä»¶ä¸­çš„ä¸­æ–­å‡½æ•°åç§°åšåŒæ ·ä¿®æ”¹ï¼Œå¹¶æ³¨é‡ŠPendSV_Handlerå‡½æ•°ï¼ˆå·²ç»åœ¨æ±‡ç¼–ä¸­æ˜¯å®ç°äº†ï¼‰</li>
</ol>
<p>PS:æˆ‘ç¬¬ä¸€æ¬¡è®¤çœŸå»çœ‹å¯åŠ¨æ–‡ä»¶,æˆ‘å‘ç°è¿™é‡Œå®šä¹‰äº†ä¸Šå­¦æœŸæˆ‘ä»¬ç”¨åˆ°æ§åˆ¶ç”µæœºçš„ä¸­æ–­å‘é‡,æ‰€ä»¥æˆ‘çŒœæµ‹ä¸­æ–­å‘é‡è¡¨æ˜¯åœ¨è¿™é‡Œå®šä¹‰çš„,è€Œstm32f4xx_it.cæ–‡ä»¶ä¸­åˆ™å®šä¹‰äº†ä¸­æ–­å‡½æ•°çš„åˆå§‹å†…å®¹,æˆ‘ä»¬å¯ä»¥ç›´æ¥ä¿®æ”¹è¿™éƒ¨åˆ†ä»£ç ä¸ç”¨é‡å®šå‘ä¸­æ–­å‡½æ•°å†…å®¹ä¹Ÿå¯ä»¥æ§åˆ¶ç”µæœº(æˆ‘æš‚æ—¶è¿˜æ²¡æœ‰å®è·µè¿‡)</p>
<p>æ–¹æ³•äºŒï¼ˆä¸ªäººæ¨èï¼Œæœ€ç»ˆä¹Ÿæ˜¯é‡‡ç”¨çš„è¿™ç§æ–¹æ¡ˆï¼‰:</p>
<p>os_cpu_a.asmé‡Œæ‰€æœ‰çš„OS_CPU_PendSVHandleræ”¹æˆPendSV_Handler  ï¼Œå¹¶æ³¨é‡Šstm32f4xx_it.cæ–‡ä»¶ä¸­çš„PendSV_Handlerå‡½æ•°</p>
<p>è¿™ç§åšæ³•çš„ç†ç”±æ˜¯,åœ¨ç³»ç»Ÿç§»æ¤è¿‡ç¨‹ä¸­,ç§»æ¤çš„ç³»ç»Ÿ,åº”è¯¥å°½å¯èƒ½å°‘çš„ä¿®æ”¹å¯åŠ¨æ–‡ä»¶ä¹‹ç±»çš„æ¿å­æœ¬èº«å¯åŠ¨æ–‡ä»¶</p>
<p><strong>æ¥ä¸‹æ¥è¿™æ­¥æ˜¯æ²¡æœ‰å¿…è¦çš„,å¯ä»¥ç›´æ¥è·³è¿‡,è¿™ä¸ªæ—¶å€™ç¼–è¯‘ä¸‹è½½å°±å·²ç»å¯ä»¥æŠŠstm32f401REæ¿å­ä¸Šçš„led2ç”µäº®äº†</strong></p>
<p>æœ€åæˆ‘ä»¬ä¿®æ”¹stm32f4xx_it.cæ–‡ä»¶ä¸­çš„SysTick_Handlerå‡½æ•°ï¼Œä½œä¸ºæ¯æ¬¡è§¦å‘å¿ƒè·³æ—¶çš„æ‰§è¡Œä»£ç ï¼Œå¦‚ä¸‹</p>
<pre class="language-none"><code class="language-none">void SysTick_Handler(void)&#123;    
	if(OSRunning&#x3D;&#x3D;1)&#123; &#x2F;&#x2F;å½“oså¼€å§‹è¿è¡Œæ‰è·‘è¿™ä¸ª        
	OSIntEnter(); &#x2F;&#x2F;è¿›å…¥ä¸­æ–­        
	OSTimeTick(); &#x2F;&#x2F;è°ƒç”¨ucosçš„æ—¶é’ŸæœåŠ¡å™¨        
	OSIntExit(); Â &#x2F;&#x2F;è§¦å‘ä»»åŠ¡åˆ‡æ¢è½¯ä¸­    
	&#125;
&#125;</code></pre>
<p>ç»è¿‡ç ”ç©¶ï¼Œä¸Šé¢è¿™æ­¥æ²¡æœ‰å¿…è¦ï¼Œå› ä¸ºæˆ‘ä»¬çš„ç³»ç»Ÿä¸­æ²¡æœ‰ä»»åŠ¡è°ƒåº¦ï¼Œç›´æ¥è¿›å…¥ç”µç¯ç¨‹åºç„¶åç³»ç»Ÿçš„å¿ƒè·³çš„æœ‰æ— ä¸å½±å“ç”µç¯ã€‚</p>
<p>ç„¶åï¼Œç¼–è¯‘ä¸‹è½½ï¼Œæ­å–œï¼</p>
</div></section><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="æ‰“èµ" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">æˆ‘å¾ˆå¯çˆ±ï¼Œè¯·ç»™æˆ‘é’±</div><div id="qr" style="display:none;"><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://gitee.com/fffyutt/img/raw/blog/img/202202280020498.jpg"><img loading="lazy" src="https://gitee.com/fffyutt/img/raw/blog/img/202202280020498.jpg" alt="æ”¯ä»˜å®" title="æ”¯ä»˜å®"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://gitee.com/fffyutt/img/raw/blog/img/202202280021331.jpg"><img loading="lazy" src="https://gitee.com/fffyutt/img/raw/blog/img/202202280021331.jpg" alt="å¾®ä¿¡æ”¯ä»˜" title="å¾®ä¿¡æ”¯ä»˜"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>æœ¬æ–‡ä½œè€…ï¼š</strong>è¯­å†°</li><li class="post-copyright-link"><strong>æœ¬æ–‡é“¾æ¥ï¼š</strong><a href="http://feutis.github.io/ucosii/ucosii1/" title="ucosiiå­¦ä¹ 1-éª—è¿‡ç¼–è¯‘å™¨">http://feutis.github.io/ucosii/ucosii1/</a></li><li class="post-copyright-license"><strong>ç‰ˆæƒå£°æ˜ï¼š</strong>æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é»˜è®¤é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> è®¸å¯åè®®ã€‚</li></ul></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/%E5%89%8D%E7%AB%AF/js%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="prev" title="jså­¦ä¹ ç¬”è®°"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">jså­¦ä¹ ç¬”è®°</span></a></div><div class="post-nav-item"></div></div></div><div class="hty-card" id="comment"></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2021 â€“ 2022 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> è¯­å†°</span></div><div class="powered"><span>ç”± <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> é©±åŠ¨ v6.0.0</span><span class="footer-separator">|</span><span>ä¸»é¢˜ - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.8.10</span></div></footer><a class="hty-icon-button" id="back-to-top" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a></div><!-- hexo injector body_end start --><script src="/js/hexo-tag-common.js"></script><!-- hexo injector body_end end --></body></html>